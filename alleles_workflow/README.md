# Alleles from HybSeq Data

Assorted shell and Python scripts to generate allele data from HybPiper output.

### Software

HybPiper (to generate supercontigs): www.github.com/mossmatters/HybPiper

Picard: http://broadinstitute.github.io/picard/

GATK: https://software.broadinstitute.org/gatk/download/

WhatsHap: http://whatshap.readthedocs.io


### Prerequisites

Run the main HybPiper script `reads_first.py` followed by `intronerate.py` to generate supercontigs for each recovered gene. This will function as "reference sequence" for identifying variants.


Concatenate all the supercontigs into a single file. Given a directory gerated by HybPiper called `prefix`:

```cat prefix/*/prefix/sequences/intron/*_supercontig.fasta > prefix.supercontigs.fasta```

Concatenate all of the GFF intron/exon boundary annotations:

```cat prefix/*/prefix/sequences/intronerate.gff > prefix.intronerate.fasta```

### `map_to_supercontigs.sh`

This script will:

1. Map paired-end reads to the supercontigs using `bwa mem`.
2. Remove duplicate reads using `picard`.
3. Identify variant sites using `gatk HaplotypeCaller`
4. Filter variant sites to identify only SNPs.
5. Generate a new set of reference sequences with SNPs replaced by IUPAC ambiguity codes, using `gatk FastaAlternateReferenceMaker`

**IMPORTANT: Modify the lines indicating paths to the picard and gatk jarfiles!**


Command line:
`bash map_to_supercontigs.sh HybPiperPrefix read1.fq read2.fq`

The Output will be Directory containing several BAM files, VCF files containing all variants and another with only SNPs, and an alternate reference file with SNPs replaced with IUPAC ambiguity bases.

### Phase alleles with WhatsHap

**Note**: WhatsHap requires Python 3. I used a conda environment specifically for whatshap to avoid conflicts with other Python environments.

Running the above script on each sample will create a set of directories containing the BAM and VCF files. To use the read data to phase this, first create a text file containing the names of these directories, one per line, called `namelist.txt`. To loop over these and generate the Phased output:

```
while read i; do cd $i; whatshap phase -o \
$i.supercontigs.fasta.snps.whatshap.vcf \
$i.supercontigs.fasta.snps.vcf \
$i.supercontigs.fasta.marked.bam; 
whatshap stats \
--gtf $i.whatshap.gtf \
--tsv $i.whatshap.stats.tsv \
$i.supercontigs.fasta.snps.whatshap.vcf; 
cd ..; 
done < ../namelist.txt
```
This will create a new VCF with phase information, and the stats command will also generate some table summarizing the phasing results.

### `extract_phase_bcftools.sh`

Run this script to generate separate files for each of the alleles generated by WhatsHap using `bcftools`.

Command: `extract_phase_bcftools.sh prefix`


`haplonerate.py` can be found in this same GitHub Repository.

The files are now ready to run `haplonerate.py` which can be found here: https://github.com/mossmatters/phyloscripts/tree/master/haplonerate

Name the output file from `haplonerate.py` as `prefix.supercontigs.alleles.fasta`

### `intron_exon_extractor.py`

Generates separate files for the intron, exon, and supercontig sequences for one sample. Will generate a separate file for each sequence. Can handle default HybPiper, IUPAC-coded, and phased-allele datasets where `_h1` and `_h2` are appended to the sample name.

Command: `python intron_exon_extractor.py prefix`

### `create_alleles_alignments.sh`

Generate combined intron and exon alignments from phased sequences:

1. Align exon sequences using MACSE
2. Align intron sequences using mafft
3. Trim both alignments using TrimAl
4. Combine intron and exon alignments and generate a RAXML partition file using `combine_alignments.py`

**NOTE: This script is provided only to show parameter settings! The PATH to files and executables is specific to our computer!**

### `combine_alignments.py`

Given an exon alignment and an intron alignment for the same gene, combine them and also output a partition file for RAXML based on codon position and intron location.

Command `python combine_alignments.py exon.fasta intron.fasta geneName`

*Requires BioPython*